name: Deploy Live Docs

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Build Unified Portal
        run: |
          # 1. Install dependencies
          uv sync --group dev
          
          # 2. Ensure the NLP model is present
          uv run python -m spacy download en_core_web_sm
          
          # 3. Execute the custom build engine
          uv run python docs.py 

          # 4. FORCE Git to track the coverage report on the runner
          # This overrides any lingering .gitignore issues during deployment
          git add -f docs/coverage_report/
          
          # Verify assets
          echo "Checking built assets in docs/ folder:"
          ls -F docs/
          echo "Checking coverage_report content:"
          ls -F docs/coverage_report/index.html || echo "ERROR: Coverage index not found!"
          
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs
          branch: gh-pages
          clean: true
          single-commit: true
          force: true
          commit-message: "Deploying Portal: ${{ github.sha }} [Forced Assets]"